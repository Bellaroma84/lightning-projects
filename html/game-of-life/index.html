<html>
    <head>
        <title>Game of Life</title>
        <style>
            * {
                font-family: monospace;
            }
            .center {
                text-align: center;
            }
            .bottom-margin {
                margin-bottom: 10px;
            }
            .grid {
                border-collapse:collapse;
                border:1px solid #000000; 
                margin: auto;
            }
            .grid-cell {
                border:1px solid #000000;
                width: 20px;
                height: 20px;
                text-align: center;
            }
            .grid-cell-alive {
                background-color: red;
            }
            .grid-cell-dead {
                background-color: white;
            }
        </style>
    </head>
    <body onload="init()">
        <div class="center bottom-margin">
            <h1 class="title">Game of Life</h1>
            <select id="pattern" name="pattern"></select>
            <button id="initButton" onclick="initSimulation()">Initialize</button>
            <button id="startButton" onclick="startSimulation()">Start Simulation</button>
            <span id="generation">0</span>
        </div>
        <table id="grid" class="grid">
            
        </table>
        <script>
            const nRows = 50;
            const nCols = 50;
            let grid;
            let timer;
            let initialized = false;
            let gen = 0;

            function init() {
                initTable();
                initSelect();

                grid = initGrid();
            }

            function startSimulation() {
                if (!initialized) {
                    console.log('game not initialized');
                    return;
                }
                if (timer) {
                    console.log('simulation in progress');
                    return;
                }
                timer = setInterval(doSimulation, 100);
                // doSimulation();
            }

            function doSimulation() {
                if (!grid) {
                    return;
                }

                const cells = Array();
                for (let [k, cell] of grid) {
                    const trId = `cell-${k}`;
                    const tr = document.getElementById(trId);

                    if (cell.isAliveNext() === true) {
                        cells.push({id: k, dead: false});
                        if (tr.classList.contains('grid-cell-dead')) {
                            tr.classList.remove('grid-cell-dead');
                        }
                        if (!tr.classList.contains('grid-cell-alive')) {
                            tr.classList.add('grid-cell-alive');
                        }
                    } else {
                        cells.push({id: k, dead: true});
                        if (tr.classList.contains('grid-cell-alive')) {
                            tr.classList.remove('grid-cell-alive');
                        }
                        if (!tr.classList.contains('grid-cell-dead')) {
                            tr.classList.add('grid-cell-dead');
                        }
                    }
                }

                cells.forEach(c => {
                    const cell = grid.get(c.id);
                    cell.dead = c.dead;
                });

                gen++;
                updateGeneration();
            }

            function updateGeneration() {
                const span = document.getElementById('generation');
                span.innerHTML = `${gen}`;
            }

            function clearGridColor() {
                for (let r = 0; r < nRows; r++) {
                    for (let c = 0; c < nCols; c++) {
                        const k = `cell-${r}-${c}`;
                        const tr = document.getElementById(k);
                        tr.classList.remove('grid-cell-alive');
                        tr.classList.remove('grid-cell-dead');

                        tr.classList.add('grid-cell-dead');

                        grid.get(`${r}-${c}`).dead = true;
                    }
                }
            }

            function updateGridColor() {
                if (!grid) {
                    return;
                }

                for (let [k, cell] of grid) {
                    if (cell.dead === false) {
                        const tr = document.getElementById(`cell-${k}`);
                        tr.classList.remove('grid-cell-dead');
                        tr.classList.add('grid-cell-alive');
                    }
                }
            }

            function initSimulation() {
                if (timer) {
                    clearInterval(timer);
                    timer = undefined;
                    console.log('cleared timer');
                }

                clearGridColor();

                const select = document.getElementById('pattern');
                const pattern = select.options[select.selectedIndex].value;
                const patterns = getPatterns();
                if (patterns.has(pattern)) {
                    const coords = patterns.get(pattern);
                    coords.forEach(coord => {
                        const i = coord[0];
                        const j = coord[1];
                        const k = `${i}-${j}`;
                        if (grid.has(k)) {
                            const cell = grid.get(k);
                            cell.dead = false;
                        }
                    })
                }

                updateGridColor();

                initialized = true;
                gen = 0;
                updateGeneration();
            }

            function initSelect() {
                const pattern = document.getElementById('pattern');
                for (let [name, indices] of getPatterns()) {
                    const option = document.createElement('option');
                    option.text = name;
                    option.value = name;
                    pattern.add(option);
                }
            }

            function initTable() {
                const table = document.getElementById('grid');
                for (let r = 0; r < nRows; r++) {
                    const tr = table.insertRow(r);
                    for (let c = 0; c < nCols; c++) {
                        const td = tr.insertCell(c);
                        td.id = `cell-${r}-${c}`;
                        td.classList.add('grid-cell');
                        td.classList.add('grid-cell-dead');
                    }
                }
            }

            function initGrid() {
                const grid = new Map();
                for (let r = 0; r < nRows; r++) {
                    for (let c = 0; c < nCols; c++) {
                        const k = `${r}-${c}`;
                        grid.set(k, getCell(r, c));
                    }
                }
                return grid;
            }

            function getCell(r, c) {
                const neighbors = Array();
                let rows;
                let cols;

                if (0 < r && r < nRows - 1 && 0 < c && c < nCols - 1) {
                    // middle cells
                    rows = [r - 1, r, r + 1];
                    cols = [c - 1, c, c + 1];
                } else if (r === 0 && 0 < c && c < nCols - 1) {
                    // top row
                    rows = [r, r + 1, nRows - 1];
                    cols = [c - 1, c, c + 1];
                } else if (r === nRows - 1 && 0 < c && c < nCols - 1) {
                    // bottom row
                    rows = [r - 1, r, 0];
                    cols = [c - 1, c, c + 1];
                } else if (c === 0 && 0 < r && r < nRows - 1) {
                    // left col
                    rows = [r - 1, r, r + 1];
                    cols = [c, c + 1, nCols - 1];
                } else if (c == nCols - 1 && 0 < r && r < nRows - 1) {
                    // right col
                    rows = [r - 1, r, r + 1];
                    cols = [c - 1, c, 0];
                } else if (r === 0 && c === 0) {
                    // top left corner
                    neighbors.push({i: r + 1, j: c});
                    neighbors.push({i: r + 1, j: c + 1});
                    neighbors.push({i: r, j: c + 1});
                    neighbors.push({i: nRows - 1, j: c});
                    neighbors.push({i: nRows - 1, j: c + 1});
                    neighbors.push({i: nRows - 1, j: nCols - 1});
                    neighbors.push({i: 0, j: nCols - 1});
                    neighbors.push({i: r + 1, j: nCols - 1});
                } else if (r === 0 && c === nCols - 1) {
                    // top right corner
                    neighbors.push({i: r, j: c - 1});
                    neighbors.push({i: r + 1, j: c - 1});
                    neighbors.push({i: r + 1, j: c});
                    neighbors.push({i: r + 1, j: 0});
                    neighbors.push({i: r, j: 0});
                    neighbors.push({i: nRows - 1, j: 0});
                    neighbors.push({i: nRows - 1, j: c});
                    neighbors.push({i: nRows - 1, j: c - 1});
                } else if (r === nRows - 1 && c === 0) {
                    // bottom left corner
                    neighbors.push({i: r - 1, j: c});
                    neighbors.push({i: r - 1, j: c + 1});
                    neighbors.push({i: r, j: c + 1});
                    neighbors.push({i: 0, j: c + 1});
                    neighbors.push({i: 0, j: c});
                    neighbors.push({i: 0, j: nCols - 1});
                    neighbors.push({i: r, j: nCols - 1});
                    neighbors.push({i: r - 1, j: nCols - 1});
                } else {
                    // bottom right corner
                    neighbors.push({i: r - 1, j: c});
                    neighbors.push({i: r - 1, j: c - 1});
                    neighbors.push({i: r, j: c - 1});
                    neighbors.push({i: 0, j: c - 1});
                    neighbors.push({i: 0, j: c});
                    neighbors.push({i: 0, j: 0});
                    neighbors.push({i: r, j: 0});
                    neighbors.push({i: r - 1, j: 0});
                }

                if (rows && cols) {
                    rows.forEach(i => {
                        cols.forEach(j => {
                            if (i === r && j === c) {
                                // do nothing
                            } else {
                                neighbors.push({i: i, j: j});
                            }
                        });
                    });
                }

                return {
                    i: r,
                    j: c,
                    dead: true,
                    neighbors: neighbors,
                    isAliveNext: function() {
                        if (this.dead === false) {
                            const neighbors = this.neighbors
                                .map(n => `${n.i}-${n.j}`)
                                .map(id => grid.get(id));
                            const nAlive = neighbors
                                .filter(n => n.dead === false)
                                .length;
                            return nAlive === 2 || nAlive === 3;
                        }
                        if (this.dead === true) {
                            const neighbors = this.neighbors
                                .map(n => `${n.i}-${n.j}`)
                                .map(id => grid.get(id));
                            const nAlive = neighbors
                                .filter(n => n.dead === false)
                                .length;
                            return nAlive === 3 ? true : false;
                        }
                        return false;
                    }
                }
            }

            function getPatterns() {
                const patterns = new Map();
                patterns.set('glider', [[3, 1], [4, 2], [4, 3], [3, 3], [2, 3]]);
                patterns.set('beacon', [[1, 1], [1, 2], [2, 1], [2, 2], [3, 3], [3, 4], [4, 3], [4, 4]]);
                patterns.set('toad', [[2, 2], [2, 3], [2, 4], [3, 1], [3, 2], [3, 3]]);
                patterns.set('blinker', [[1, 2], [2, 2], [3, 2]]);
                patterns.set('r-pentomino', [[2, 1], [1, 2], [2, 2], [3, 2], [1, 3]]);
                return patterns;
            }
        </script>
    </body>
</html>